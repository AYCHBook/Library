<% title "#{@project} #{@version} on #{@project.platform} - Libraries" %>
<% description @project.description if @project.description.present?  %>

<div class='row'>
  <div class='col-md-8'>
    <h1>
      <%= @project %>
      <small>
        <% if @version %>
          <%= @version %>
        <% else %>
          <%= @project.latest_version %>
        <% end %>
      </small>
      <% if logged_in? %>
        <% if current_user.subscribed_to?(@project) %>
          <%= link_to 'Unsubscribe', subscription_path(current_user.subscribed_to?(@project)), method: :delete, class: 'btn btn-default pull-right' %>
        <% else %>
          <%= link_to 'Subscribe', subscriptions_path(project_id: @project.id), method: :post, class: 'btn btn-primary pull-right' %>
        <% end %>
      <% end %>
    </h1>

    <% if @project.description.present? %>
    <p>
      <%= @project.description %>
    </p>
    <% end %>

    <% if @project.homepage.present? && @project.homepage != package_link(@project.name, @project.platform) %>
    <p>
      <%= link_to(@project.homepage, sanitize_url(@project.homepage)) %>
    </p>
    <% end %>

    <p>
      Platform: <%= link_to @project.platform, platform_path(@project.platform.downcase) %>
    </p>

    <% if @project.normalized_licenses.present? %>
    <p>
      <%= 'License'.pluralize(@project.normalized_licenses.length) %>: <%= linked_licenses @project.normalized_licenses %>
    </p>
    <% end %>

    <% if @project.keywords.present? %>
    <p>
      <%= 'Keyword'.pluralize(@project.keywords.split(',').length) %>: <%= linked_keywords @project.keywords %>
    </p>
    <% end %>

    <% if link = package_link(@project.name, @project.platform, @version.try(:number)) %>
    <p>
      View on registry: <%= link_to truncate(link, length: 70), link %>
    </p>
    <% end %>

    <% if @project.github_url.present? && @github_repository.nil? %>
      <p>
        Repo: <%= link_to @project.github_url, sanitize_url(@project.github_url) %>
      </p>
    <% end %>

    <% if install_instructions(@project.name, @project.platform, @version.try(:number)) %>
      <p>
        Install:
        <code>
          <%= install_instructions(@project.name, @project.platform, @version.try(:number)) %>
        </code>
      </p>
    <% end %>

    <% if @github_repository.present? && @github_repository.readme.present? %>
    <hr>
    <%== @github_repository.readme %>
    <% end %>

    <% if @dependencies.any? || @dependents.any? %>
      <div class="row">
        <hr>
        <% if @dependencies.any? %>
        <div class="col-md-6">
          <% @dependencies.group_by(&:kind).each do |kind, dependencies| %>
            <h4><%= kind.humanize unless kind == 'normal' %> Dependencies</h4>
            <ul>
              <% dependencies.each do |dependency| %>
                <li>
                  <%= link_to dependency.project_name, project_path(name: dependency.project_name, platform: dependency.platform.downcase) %>
                  <%= dependency.requirements %>
                </li>
              <% end %>
            </ul>
          <% end %>
        </div>
        <% end %>

        <% if @dependents.any? %>
          <div class="col-md-6">
            <h4>Dependents</h4>
            <ul>
              <% @dependents.each do |project| %>
              <li>
                <%= link_to project.name, project_path(project.to_param) %>
              </li>
              <% end %>
            </ul>
            <%= link_to 'See all dependents', project_dependents_path(@project.to_param) %>
          </div>
        <% end %>
      </div>
    <% end %>

    <%= render 'projects/github' if @github_repository.present? %>
  </div>

  <div class='col-md-4'>
    <% if @versions.any? %>
    <h4>Releases</h4>
    <ul>
      <% @versions.each do |version| %>
      <li>
        <% if version == @version %>
          <strong><%= version %></strong>
        <% else %>
          <%= link_to version, version_path(version.to_param) %>
        <% end %>
        <% if version.published_at.present? %>
        - <%= version.published_at.to_date.to_s(:long) %>
        <% end %>
      </li>
      <% end %>
    </ul>
    <% end %>

    <% cache("projects:#{@project.id}:related", :expires_in => 1.day) do %>
      <% related = @project.mlt %>
      <% if related && related.any? %>
        <% if versions.any? %>
          <hr>
        <% end %>
        <h4>Related Projects</h4>
        <%= render related %>
      <% end %>
    <% end %>
  </div>
</div>
